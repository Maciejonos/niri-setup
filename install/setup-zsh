#!/bin/bash

set -e

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
source "$SCRIPT_DIR/lib/helpers.sh"
source "$SCRIPT_DIR/lib/backup.sh"
DOTFILES_DIR="$HOME/.local/share/dotfiles"

# Setup zsh
log_info "Setting zsh as default shell..."
ZSH_PATH=/usr/bin/zsh
CURRENT_SHELL=$(getent passwd $USER | cut -d: -f7)

if [ "$CURRENT_SHELL" != "$ZSH_PATH" ]; then
    sudo chsh -s "$ZSH_PATH" "$USER"
    log_success "Default shell changed to zsh"
    log_info "Note: You need to log out and back in for shell change to take effect"
else
    log_detail "zsh is already the default shell"
fi

# Install Oh My Zsh
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    log_info "Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    log_success "Oh My Zsh installed"
else
    log_detail "Oh My Zsh already installed"
fi

# Install zsh plugins
log_info "Installing zsh plugins..."
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"

if [ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]; then
    git clone https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
    log_success "zsh-autosuggestions installed"
else
    log_detail "zsh-autosuggestions already installed"
fi

if [ ! -d "$ZSH_CUSTOM/plugins/fast-syntax-highlighting" ]; then
    git clone https://github.com/zdharma-continuum/fast-syntax-highlighting.git \
      "$ZSH_CUSTOM/plugins/fast-syntax-highlighting"
    log_success "fast-syntax-highlighting installed"
else
    log_detail "fast-syntax-highlighting already installed"
fi

log_info "Setting up .zshrc..."
if [ -f "$HOME/.zshrc" ] || [ -L "$HOME/.zshrc" ]; then
    if [ -e "$HOME/.zshrc" ]; then
        backup_file "$HOME/.zshrc" || {
            log_error "Failed to backup .zshrc"
            exit 1
        }
    fi
    remove_path "$HOME/.zshrc"
fi
cp "$DOTFILES_DIR/default/.zshrc" "$HOME/.zshrc"

log_success "Zsh setup finished"
