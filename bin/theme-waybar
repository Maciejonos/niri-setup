#!/bin/bash

WAYBAR_DIR="$HOME/.config/waybar"
THEMES_DIR="$WAYBAR_DIR/themes"
STYLE_CSS="$WAYBAR_DIR/style.css"
CONFIG="$WAYBAR_DIR/config"

# Check if themes directory exists
if [[ ! -d "$THEMES_DIR" ]]; then
  notify-send "Error" "Waybar themes directory not found: $THEMES_DIR"
  exit 1
fi

# List available waybar themes
themes=$(find "$THEMES_DIR" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) | sort | while read -r path; do
  theme_name="$(basename "$path")"
  echo "$(echo "$theme_name" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')"
done)

if [[ -z "$themes" ]]; then
  notify-send "Error" "No waybar themes found"
  exit 1
fi

# Select theme using walker
selected=$(echo "$themes" | walker --dmenu --theme menus --width 295 --minheight 1 --maxheight 600 -p "Select" 2>/dev/null)

if [[ "$selected" == "CNCLD" || -z "$selected" ]]; then
  exit 0
fi

selected=$(echo "$selected" | tr -d '\n' | xargs)

theme_name=$(echo "$selected" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
theme_path="$THEMES_DIR/$theme_name"

# Check if theme directory exists
if [[ ! -d "$theme_path" ]]; then
  notify-send "Error" "Waybar theme '$theme_name' does not exist"
  exit 1
fi

# Apply the theme
if [[ -f "$theme_path/style.css" ]]; then
  cat "$theme_path/style.css" >"$STYLE_CSS"
fi

if [[ -f "$theme_path/config" ]]; then
  cat "$theme_path/config" >"$CONFIG"
fi

# Restart waybar
restart-app waybar

notify-send "Waybar Theme" "Switched to $selected"
