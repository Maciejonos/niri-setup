#!/bin/bash
source "$HOME/.local/share/dotfiles/bin/lib/helpers.sh"
set -e

log_header "PostgreSQL Backup"

log_step "Fetching PostgreSQL databases..."
databases=$(psql -d postgres -t -c "SELECT datname FROM pg_database WHERE datistemplate = false AND datname NOT IN ('postgres');" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')

if ! command -v fzf &>/dev/null; then
  log_error "fzf is not installed"
  exit 1
fi

if ! command -v pv &>/dev/null; then
  log_error "pv is not installed"
  exit 1
fi

selected_dbs=$(echo "$databases" | fzf --multi --prompt="Select databases (Tab to select multiple): " --height=40% --border)

if [ -z "$selected_dbs" ]; then
  log_info "No databases selected. Exiting."
  exit 0
fi

backup_dir="$HOME/postgres_backups"
mkdir -p "$backup_dir"
timestamp=$(date +%Y-%m-%d_%H%M)

log_step "Starting backup..."
echo "$selected_dbs" | while read -r db; do
  backup_file="$backup_dir/${db}_${timestamp}.backup"
  log_info "Backing up: $db"

  pg_dump -Fc "$db" | pv >"$backup_file"

  log_success "$db backed up"
  log_detail "$backup_file"
  echo ""
done

log_detail "Backup location: $backup_dir"
show_done
