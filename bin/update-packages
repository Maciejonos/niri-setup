#!/bin/bash
source "$HOME/.local/share/dotfiles/bin/lib/helpers.sh"

DOTFILES_DIR="$HOME/.local/share/dotfiles"
PKGS_FILE="$DOTFILES_DIR/install/pkgs.txt"

log_step "Checking for new packages..."

NEW_PKGS=()
while IFS= read -r pkg; do
  [[ -z "$pkg" || "$pkg" =~ ^# ]] && continue

  if ! pacman -Q "$pkg" &>/dev/null; then
    NEW_PKGS+=("$pkg")
  fi
done < "$PKGS_FILE"

if [ ${#NEW_PKGS[@]} -eq 0 ]; then
  log_info "All packages already installed"
  exit 0
fi

log_info "Installing ${#NEW_PKGS[@]} new package(s) with update..."
for pkg in "${NEW_PKGS[@]}"; do
  if spinner "Installing $pkg..." paru --noconfirm --needed -S "$pkg" 2>&1; then
    log_success "$pkg"
  else
    log_error "Failed: $pkg"
  fi
done
