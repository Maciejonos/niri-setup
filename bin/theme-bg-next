#!/bin/bash

BACKGROUNDS_DIR="$HOME/.local/share/dotfiles/current/theme/backgrounds/"
CURRENT_BACKGROUND_LINK="$HOME/.local/share/dotfiles/current/background"

mapfile -d '' -t BACKGROUNDS < <(find "$BACKGROUNDS_DIR" -type f -print0 | sort -z)
TOTAL=${#BACKGROUNDS[@]}

if [[ $TOTAL -eq 0 ]]; then
  notify-send "No background was found for theme" -t 2000
  hyprctl hyprpaper unload all
else
  if [[ -L "$CURRENT_BACKGROUND_LINK" ]]; then
    CURRENT_BACKGROUND=$(readlink "$CURRENT_BACKGROUND_LINK")
  else
    CURRENT_BACKGROUND=""
  fi

  INDEX=-1
  for i in "${!BACKGROUNDS[@]}"; do
    if [[ "${BACKGROUNDS[$i]}" == "$CURRENT_BACKGROUND" ]]; then
      INDEX=$i
      break
    fi
  done

  if [[ $INDEX -eq -1 ]]; then
    NEW_BACKGROUND="${BACKGROUNDS[0]}"
  else
    NEXT_INDEX=$(((INDEX + 1) % TOTAL))
    NEW_BACKGROUND="${BACKGROUNDS[$NEXT_INDEX]}"
  fi

  ln -nsf "$NEW_BACKGROUND" "$CURRENT_BACKGROUND_LINK"

  hyprctl monitors -j | jq -r '.[].name' | while read -r monitor; do
    hyprctl hyprpaper reload "$monitor,$NEW_BACKGROUND"
  done
fi
